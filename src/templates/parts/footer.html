<footer class="main-footer">
    <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong>
    All rights reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="{{ url_for('static', path='plugins/jquery/jquery.min.js') }}"></script>
<!-- jQuery UI 1.11.4 -->
<script src="{{ url_for('static', path='plugins/jquery-ui/jquery-ui.min.js') }}"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="{{ url_for('static', path='plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<!-- DataTables  & Plugins -->
<script src="{{ url_for('static', path='plugins/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-bs4/js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-responsive/js/dataTables.responsive.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-responsive/js/responsive.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-buttons/js/dataTables.buttons.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-buttons/js/buttons.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/jszip/jszip.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/pdfmake/pdfmake.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/pdfmake/vfs_fonts.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-buttons/js/buttons.html5.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-buttons/js/buttons.print.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-buttons/js/buttons.colVis.min.js') }}"></script>
<!-- Toastr -->
<script src="{{ url_for('static', path='plugins/toastr/toastr.min.js') }}"></script>
<!-- ChartJS -->
<script src="{{ url_for('static', path='plugins/chart.js/Chart.min.js') }}"></script>
<!-- Sparkline -->
<script src="{{ url_for('static', path='plugins/sparklines/sparkline.js') }}"></script>
<!-- JQVMap -->
<script src="{{ url_for('static', path='plugins/jqvmap/jquery.vmap.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/jqvmap/maps/jquery.vmap.usa.js') }}"></script>
<!-- jQuery Knob Chart -->
<script src="{{ url_for('static', path='plugins/jquery-knob/jquery.knob.min.js') }}"></script>
<!-- daterangepicker -->
<script src="{{ url_for('static', path='plugins/moment/moment.min.js') }}"></script>
<script src="{{ url_for('static', path='plugins/daterangepicker/daterangepicker.js') }}"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="{{ url_for('static', path='plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
<!-- Summernote -->
<script src="{{ url_for('static', path='plugins/summernote/summernote-bs4.min.js') }}"></script>
<!-- overlayScrollbars -->
<script src="{{ url_for('static', path='plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js') }}"></script>
<!-- AdminLTE App -->
<script src="{{ url_for('static', path='assets/js/adminlte.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script>
    $(function () {
      $("#example1").DataTable({
        "responsive": true, "lengthChange": false, "autoWidth": false
      }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
    });


  // Add a tile layer to the map
    try{
      var map = L.map('map').setView([-7.280743, 112.795056], 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    var icon_node1 = L.icon({
      iconUrl: '{{url_for("static",path="assets/img/tower1.png")}}',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
    var icon_node2 = L.icon({
      iconUrl: '{{url_for("static",path="assets/img/tower2.png")}}',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
    var icon_node3 = L.icon({
      iconUrl: '{{url_for("static",path="assets/img/tower3.png")}}',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
    var icon_node4 = L.icon({
      iconUrl: '{{url_for("static",path="assets/img/boat.png")}}',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
    var tower1 = L.marker([-7.2782725, 112.7938762], { icon: icon_node1 }).addTo(map);
    var tower2 = L.marker([-7.2781905, 112.7939742], { icon: icon_node2 }).addTo(map);
    var tower3 = L.marker([-7.2783495, 112.7934002], { icon: icon_node3 }).addTo(map);
    var ship = L.marker([-7.2786715, 112.7932752], { icon: icon_node4 }).addTo(map);
    {% for item in data_map%}
      if("{{item.ship_id}}"=="1"){
        if ("{{item.latitude}}"!=0.0 && "{{item.longitude}}" != 0.0 ){
          tower1 = L.marker([parseFloat({{item.latitude}}), parseFloat({{item.longitude}})], { icon: icon_node1 }).addTo(map)
        }
        tower1.bindPopup(
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Ship Id: "+item.ship_id+"</b>"+
            "<b>Nama Kapal: "+item.nama_kapal+"</b>"+
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Yaw: "+item.yaw+"</b>"+
            "<b>Pitch: "+item.pitch+"</b>"+
            "<b>Roll: "+item.roll+"</b>"
          );
      }
      else if("{{item.ship_id}}"=="2"){
        if ("{{item.latitude}}"!=0.0 && "{{item.longitude}}" != 0.0 ){
          tower2 = L.marker([parseFloat({{item.latitude}}), parseFloat({{item.longitude}})], { icon: icon_node2 }).addTo(map);
        }
        tower2.bindPopup(
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Ship Id: "+item.ship_id+"</b>"+
            "<b>Nama Kapal: "+item.nama_kapal+"</b>"+
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Yaw: "+item.yaw+"</b>"+
            "<b>Pitch: "+item.pitch+"</b>"+
            "<b>Roll: "+item.roll+"</b>"
          );
      }
      else if("{{item.ship_id}}"=="3"){
        if ("{{item.latitude}}"!=0.0 && "{{item.longitude}}" != 0.0 ){
          tower3 = L.marker([parseFloat({{item.latitude}}), parseFloat({{item.longitude}})], { icon: icon_node3 }).addTo(map);
        }
        tower3.bindPopup(
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Ship Id: "+item.ship_id+"</b>"+
            "<b>Nama Kapal: "+item.nama_kapal+"</b>"+
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Yaw: "+item.yaw+"</b>"+
            "<b>Pitch: "+item.pitch+"</b>"+
            "<b>Roll: "+item.roll+"</b>"
          );
      }
      else if("{{item.ship_id}}"=="4"){
        if ("{{item.latitude}}"!=0.0 && "{{item.longitude}}" != 0.0 ){
          ship = L.marker([parseFloat({{item.latitude}}), parseFloat({{item.longitude}})], { icon: icon_node4 }).addTo(map);
        }
        ship.bindPopup(
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Ship Id: "+item.ship_id+"</b>"+
            "<b>Nama Kapal: "+item.nama_kapal+"</b>"+
            "<b>Message Id: "+item.msg_id+"</b>"+
            "<b>Yaw: "+item.yaw+"</b>"+
            "<b>Pitch: "+item.pitch+"</b>"+
            "<b>Roll: "+item.roll+"</b>"
          );
      }

    {% endfor %}
    }
    catch{
      console.log("error");
    }
   
    var mqtt;
    var reconnectTimeout = 2000;
    var host="188.166.242.227"; //change this
    var port=9001;

    function onFailure(message) {
      console.log("Connection Attempt to Host "+host+"Failed");
      setTimeout(MQTTconnect, reconnectTimeout);
        }
    function onMessageArrived(msg){
      var message = ""+msg.payloadString;
      try{
        var message_split = message.split("&");
        var jsonMessage = {};
        for(i=0;i<message_split.length;i++){
          key_value = message_split[i].split("=");
          jsonMessage[key_value[0]] = key_value[1];
        }

        if(jsonMessage.ship_id == "1" && parseFloat(jsonMessage.latitude)!=0 && parseFloat(jsonMessage.longitude)!=0){
          tower1.setLatLng([jsonMessage.latitude, jsonMessage.longitude]);
          tower1.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if (jsonMessage.ship_id == "1"){
          tower1.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        
        else if(jsonMessage.ship_id == "2" && parseFloat(jsonMessage.latitude)!=0 && parseFloat(jsonMessage.longitude)!=0){
          tower2.setLatLng([jsonMessage.latitude, jsonMessage.longitude]);
          tower2.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if(jsonMessage.ship_id == "2"){
          tower2.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if(jsonMessage.ship_id=="3" && parseFloat(jsonMessage.latitude)!=0 && parseFloat(jsonMessage.longitude)!=0){
          tower3.setLatLng([jsonMessage.latitude, jsonMessage.longitude]);
          tower3.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if(jsonMessage.ship_id=="3"){
          tower3.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if(jsonMessage.ship_id=="4" && parseFloat(jsonMessage.latitude)!=0 && parseFloat(jsonMessage.longitude)!=0){
          ship.setLatLng([jsonMessage.latitude, jsonMessage.longitude]);
          ship.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
        else if(jsonMessage.ship_id=="4"){
          ship.bindPopup(
            "<b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Ship Id: "+jsonMessage.ship_id+"</b>"+
            "<br><b>Nama Kapal: "+jsonMessage.nama_kapal+"</b>"+
            "<br><b>Message Id: "+jsonMessage.msg_id+"</b>"+
            "<br><b>Yaw: "+jsonMessage.yaw+"</b>"+
            "<br><b>Pitch: "+jsonMessage.pitch+"</b>"+
            "<br><b>Roll: "+jsonMessage.roll+"</b>"
          );
        }
      }
      catch {
        console.log("error");
      }
    }

    function onConnect() {
    console.log("Connected ");
    mqtt.subscribe("/ppns/monitor_kapal");
    }

    console.log("connecting to "+ host +" "+ port);
    var x=Math.floor(Math.random() * 10000); 
    var cname="orderform-"+x;
    mqtt = new Paho.MQTT.Client(host,port,cname);
    var options = {
      timeout: 3,
      onSuccess: onConnect,
      onFailure: onFailure,
      };
    mqtt.onMessageArrived = onMessageArrived

    mqtt.connect(options); 

  </script>

</body>
</html>
